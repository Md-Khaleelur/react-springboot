pipeline {
    agent any
    environment {
                registry = 'docker.pkg.github.com/zemoso-int/devops-bootcamp-3/'
                registryCredential = 'github-registry'
                GH_TOKEN = credentials('GHB_TOKEN')
                dockerImage = ''
    }
    stages {
        stage('Build backend') {
            steps {
                checkout scm
                sh 'pwd'
                sh 'cd book-discovery-app/bc-5-backend/book-management-service && mvn -B -DskipTests clean package'
            }
        }
        stage('Testing backend') {
            steps {
                sh 'pwd'
                sh 'cd book-discovery-app/bc-5-backend/book-management-service && mvn test'
            }
        }
        stage('Building Docker Image for backend') {
            steps {
                dir('book-discovery-app/bc-5-backend/book-management-service') {

                 sh "docker build . -t "+registry+"book-discovery-backend:$BUILD_NUMBER -t "+registry+"book-discovery-backend:latest"

                }
            }
        }
        stage('Deploy Docker Image for backend') {
            steps {
				sh 'echo ${GH_TOKEN} | docker login docker.pkg.github.com -u Md-Khaleelur --password-stdin'
                sh 'docker push ' + registry + "book-discovery-backend:$BUILD_NUMBER"
                sh 'docker push ' + registry + "book-discovery-backend:latest"
            }
        }
        stage('Build frontend') {
                    steps {
                        sh 'pwd'
                        sh 'cd book-discovery-app/bc-5-frontend && rm -rf node_modules/ && npm install'
                    }
        }
        stage('Testing frontend') {
                    steps {
                        sh 'pwd'
                        sh 'cd book-discovery-app/bc-5-frontend && npm run test'
                    }
        }
        stage('Building Docker Image for frontend') {
            steps {
                dir('book-discovery-app/bc-5-frontend') {

                        sh '''echo -n "\
                               REACT_APP_BACKEND_HOST=${REACT_APP_BACKEND_HOST}" >.env'''
                        sh "docker build . -t "+registry+"book-discovery-frontend:$BUILD_NUMBER -t "+registry+"book-discovery-frontend:latest"

                }
            }
        }
        stage('Deploy Docker Image for frontend') {
            steps {
				sh 'echo ${GH_TOKEN} | docker login docker.pkg.github.com -u Md-Khaleelur --password-stdin'
                sh 'docker push ' + registry + "book-discovery-frontend:$BUILD_NUMBER"
                sh 'docker push ' + registry + "book-discovery-frontend:latest"
            }
        }
        stage('Deploy front end to kubernetes cluster - minikube') {
        	steps {
        		dir("book-discovery-app/helm_charts/") {
        				sh "helm package bdiscovery"
        				sh "helm install bdiscovery bdiscovery-0.1.0.tgz"
        		}
            }
        }
    }
}
